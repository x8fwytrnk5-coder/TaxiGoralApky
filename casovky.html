<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ƒåasovky ‚Äì Mana≈æ√©r vodiƒça taxislu≈æby</title>

<!-- Leaflet mapa (mal√° verzia) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
  body {
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f2f2f7;
  }

  #top {
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(20px);
    padding: 16px;
    font-size: 22px;
    font-weight: 600;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  #container {
    padding: 20px;
  }

  label {
    display: block;
    margin-bottom: 6px;
    font-size: 14px;
    color: #555;
  }

  input, select {
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid #d0d0d5;
    font-size: 16px;
    background: #fff;
    margin-bottom: 16px;
  }

  input:focus, select:focus {
    border-color: #0A84FF;
    box-shadow: 0 0 0 2px rgba(10,132,255,0.2);
  }

  button {
    width: 100%;
    padding: 14px;
    border-radius: 14px;
    border: none;
    font-size: 17px;
    font-weight: 600;
    margin-bottom: 14px;
    cursor: pointer;
    transition: 0.15s ease;
  }

  .primary {
    background: #0A84FF;
    color: white;
  }

  .primary:hover {
    background: #006FE0;
  }

  .secondary {
    background: #8E8E93;
    color: white;
  }

  #map {
    height: 200px;
    border-radius: 14px;
    margin-bottom: 20px;
  }

  #result {
    font-size: 26px;
    font-weight: 700;
    margin-top: 10px;
  }

  #debug {
    margin-top: 20px;
    padding: 10px;
    background: #eee;
    border-radius: 10px;
    font-size: 12px;
    height: 140px;
    overflow-y: auto;
  }

  #back {
    position: fixed;
    bottom: 12px;
    left: 12px;
    padding: 10px 16px;
    background: #0A84FF;
    color: white;
    border-radius: 12px;
    font-size: 15px;
    text-decoration: none;
  }
</style>
</head>

<body>

<div id="top">ƒåasovky</div>

<div id="container">

  <label>Adresa n√°stupu klienta:</label>
  <input id="pickup" placeholder="Napr. Rooseveltova 10, Bansk√° Bystrica">

  <label>Adresa v√Ωstupu klienta:</label>
  <input id="dropoff" placeholder="Napr. N√°mestie SNP 1, Bansk√° Bystrica">

  <label>Poloha vozidla (automaticky pri ≈°tarte):</label>
  <input id="gps" disabled placeholder="Zatiaƒæ nezameran√©">

  <label>Upozorni≈• pred ƒçasovkou:</label>
  <select id="alert-time">
    <option value="15">15 min</option>
    <option value="30">30 min</option>
    <option value="45">45 min</option>
    <option value="60">60 min</option>
  </select>

  <div id="map"></div>

  <button class="primary" id="start-po">Zaƒça≈• dojazd po klienta</button>
  <button class="primary" id="client-in" disabled>Klient nast√∫pil</button>
  <button class="primary" id="calc" disabled>Vypoƒç√≠ta≈• cenu</button>
  <button class="primary" id="save" disabled>üíæ Ulo≈æi≈• ƒçasovku</button>
  <button class="secondary" id="reset">Reset</button>

  <div id="result"></div>

  <div id="debug"><b>DEBUG:</b><br></div>
</div>

<a id="back" href="hlMenu.html">‚Üê Sp√§≈•</a>

<script>
function dbg(t) {
  const d = document.getElementById("debug");
  d.innerHTML += t + "<br>";
  d.scrollTop = d.scrollHeight;
}

/* MAPA */
let map = L.map("map").setView([48.7394, 19.1536], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let gpsMarker = null;

/* PREMENN√â */
let mode = "idle";
let lastGPS = null;
let kmPo = 0;
let kmS = 0;
let cenaSpolu = 0;

/* GPS MERANIE */
function dist(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLon = (lon2-lon1)*Math.PI/180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
            Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

setInterval(() => {
  if (mode !== "po") return;

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    if (!lastGPS) {
      lastGPS = {lat, lon};
      return;
    }

    const km = dist(lastGPS.lat, lastGPS.lon, lat, lon);
    kmPo += km;
    lastGPS = {lat, lon};

    dbg(`+${km.toFixed(3)} km (po klienta)`);
  });
}, 3000);

/* GEOK√ìDOVANIE */
async function geocode(addr) {
  const url = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" +
              encodeURIComponent(addr);

  const r = await fetch(url);
  const j = await r.json();
  if (!j.length) throw new Error("Adresa sa nena≈°la: " + addr);

  return {lat: parseFloat(j[0].lat), lon: parseFloat(j[0].lon)};
}

/* OSRM */
async function routeKm(a, b) {
  const url = `https://router.project-osrm.org/route/v1/driving/${a.lon},${a.lat};${b.lon},${b.lat}?overview=false`;
  const r = await fetch(url);
  const j = await r.json();
  return j.routes[0].distance / 1000;
}

/* TLAƒåIDL√Å */
document.getElementById("start-po").onclick = () => {
  mode = "po";
  kmPo = 0;
  lastGPS = null;

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    document.getElementById("gps").value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;

    if (gpsMarker) gpsMarker.remove();
    gpsMarker = L.marker([lat, lon]).addTo(map);

    map.setView([lat, lon], 14);
  });

  document.getElementById("client-in").disabled = false;
  dbg("Zaƒçiatok merania po klienta");
};

document.getElementById("client-in").onclick = () => {
  mode = "idle";
  dbg("Klient nast√∫pil ‚Äì meranie po klienta ukonƒçen√©");

  document.getElementById("calc").disabled = false;
};

document.getElementById("calc").onclick = async () => {
  const pickup = document.getElementById("pickup").value.trim();
  const dropoff = document.getElementById("dropoff").value.trim();

  if (!pickup || !dropoff) {
    alert("Zadaj adresy");
    return;
  }

  dbg("Geok√≥dujem‚Ä¶");
  const a = await geocode(pickup);
  const b = await geocode(dropoff);

  dbg("Poƒç√≠tam trasu s klientom‚Ä¶");
  kmS = await routeKm(a, b);

  const cenaPo = kmPo * 0.40;
  const cenaS = kmS * 0.85;
  cenaSpolu = cenaPo + cenaS;

  document.getElementById("result").innerHTML =
    `Cena spolu: <b>${cenaSpolu.toFixed(2)} ‚Ç¨</b><br>
     Po klienta: ${kmPo.toFixed(2)} km<br>
     S klientom: ${kmS.toFixed(2)} km`;

  document.getElementById("save").disabled = false;
};

/* ULO≈ΩENIE DO KALEND√ÅRA */
document.getElementById("save").onclick = () => {
  const pickup = document.getElementById("pickup").value;
  const dropoff = document.getElementById("dropoff").value;
  const alertMin = document.getElementById("alert-time").value;

  const now = new Date();
  const dt = now.toISOString().replace(/[-:]/g, "").split(".")[0] + "Z";

  const summary = `ƒåasovka ‚Äì ${pickup} ‚Üí ${dropoff}`;
  const desc =
    `Po klienta: ${kmPo.toFixed(2)} km\n` +
    `S klientom: ${kmS.toFixed(2)} km\n` +
    `Cena spolu: ${cenaSpolu.toFixed(2)} ‚Ç¨`;

  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
SUMMARY:${summary}
DTSTART:${dt}
DTEND:${dt}
DESCRIPTION:${desc}
BEGIN:VALARM
TRIGGER:-PT${alertMin}M
ACTION:DISPLAY
DESCRIPTION:Pripomienka ƒçasovky
END:VALARM
END:VEVENT
END:VCALENDAR`;

  const blob = new Blob([ics], {type:"text/calendar"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "casovka.ics";
  a.click();

  URL.revokeObjectURL(url);
};

/* RESET */
document.getElementById("reset").onclick = () => {
  location.reload();
};
</script>

</body>
</html>
