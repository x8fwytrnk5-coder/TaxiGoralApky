<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <title>Taxi app – Slovensko autocomplete</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f5f5f5;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        header {
            padding: 8px 10px;
            background: #111827;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .controls {
            padding: 8px 10px;
            background: #e5e7eb;
        }

        .row {
            position: relative;
            margin-bottom: 6px;
        }

        label {
            font-size: 11px;
            color: #374151;
            display: block;
            margin-bottom: 2px;
        }

        input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 14px;
            box-sizing: border-box;
        }

        .buttons {
            display: flex;
            gap: 6px;
            margin-top: 4px;
            margin-bottom: 4px;
        }

        button {
            flex: 1;
            padding: 6px 8px;
            font-size: 13px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-secondary {
            background: #4b5563;
            color: white;
        }

        .status {
            font-size: 11px;
            color: #4b5563;
        }

        #map {
            flex: 1;
        }

        /* Autocomplete */
        .autocomplete-list {
            position: absolute;
            left: 0;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #d1d5db;
            max-height: 220px;
            overflow-y: auto;
            z-index: 9999;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .autocomplete-item {
            padding: 6px 8px;
            cursor: pointer;
            font-size: 13px;
        }
        .autocomplete-item:hover {
            background: #f3f4f6;
        }
    </style>
</head>
<body>
<div id="app">
    <header>
        Taxi – Slovensko autocomplete (Overpass + OSRM)
    </header>

    <div class="controls">
        <div class="row">
            <label for="pickupInput">Odkiaľ (klient)</label>
            <input id="pickupInput" type="text" placeholder="Začni písať adresu, ulicu, obec...">
        </div>
        <div class="row">
            <label for="dropoffInput">Kam</label>
            <input id="dropoffInput" type="text" placeholder="Začni písať cieľ...">
        </div>

        <div class="buttons">
            <button id="btnToClient" class="btn-primary">Po klienta</button>
            <button id="btnWithClient" class="btn-secondary">S klientom</button>
        </div>

        <div class="status" id="status">
            GPS: čakám na polohu...
        </div>
    </div>

    <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="">
</script>

<script>
/* ===================== ZÁKLAD – MAPA, GPS, STAV ====================== */

let map;
let carMarker = null;
let pickupMarker = null;
let dropoffMarker = null;
let routeLine = null;

let carPosition = null;
let pickupPosition = null;
let dropoffPosition = null;

function initMap() {
    map = L.map('map').setView([48.7386, 19.7060], 7); // približne stred SR

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);
}

function updateStatus(text) {
    document.getElementById('status').textContent = text;
}

function startGPS() {
    if (!navigator.geolocation) {
        updateStatus("GPS nie je podporované v tomto prehliadači.");
        return;
    }

    navigator.geolocation.watchPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            carPosition = [lat, lon];

            if (!carMarker) {
                carMarker = L.marker([lat, lon], {title: "Auto"}).addTo(map);
                map.setView([lat, lon], 14);
            } else {
                carMarker.setLatLng([lat, lon]);
            }

            updateStatus(`GPS: ${lat.toFixed(5)}, ${lon.toFixed(5)}`);
        },
        err => {
            updateStatus("GPS chyba: " + err.message);
        },
        { enableHighAccuracy: true }
    );
}

/* ===================== DEBOUNCE ====================== */

function debounce(fn, delay) {
    let timer = null;
    return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
    };
}

/* ===================== OVERPASS AUTOCOMPLETE (SR) ====================== */

async function autocompleteSearchSk(query) {
    const url = "https://overpass-api.de/api/interpreter";

    // Je to zamerané na Slovensko cez addr:country=SK + name/addr:street
    const q = `
        [out:json][timeout:25];
        (
          node["name"]["addr:country"="SK"][name~"${query}",i];
          way["name"]["addr:country"="SK"][name~"${query}",i];
          relation["name"]["addr:country"="SK"][name~"${query}",i];

          node["addr:street"]["addr:country"="SK"][addr:street~"${query}",i];
          way["addr:street"]["addr:country"="SK"][addr:street~"${query}",i];

          node["place"]["addr:country"="SK"][name~"${query}",i];
          relation["place"]["addr:country"="SK"][name~"${query}",i];

          node["amenity"]["addr:country"="SK"][name~"${query}",i];
          way["amenity"]["addr:country"="SK"][name~"${query}",i];
        );
        out center 20;
    `;

    try {
        const response = await fetch(url, {
            method: "POST",
            body: q
        });
        const data = await response.json();

        return data.elements.map(el => {
            const lat = el.lat || (el.center && el.center.lat);
            const lon = el.lon || (el.center && el.center.lon);
            let label = el.tags && (el.tags.name || el.tags["addr:street"]);
            if (!label) label = "Neznáme";

            return {
                name: label,
                lat,
                lon
            };
        }).filter(item => item.lat && item.lon);
    } catch (e) {
        console.error("Overpass chyba:", e);
        return [];
    }
}

/* ===================== AUTOCOMPLETE RENDERING ====================== */

function createAutocompleteList(input) {
    let list = input.parentNode.querySelector(".autocomplete-list");
    if (!list) {
        list = document.createElement("div");
        list.className = "autocomplete-list";
        input.parentNode.appendChild(list);
    }
    return list;
}

function clearAutocompleteList(input) {
    const list = input.parentNode.querySelector(".autocomplete-list");
    if (list) list.innerHTML = "";
}

function renderAutocomplete(input, results, onSelect) {
    const list = createAutocompleteList(input);
    list.innerHTML = "";

    results.forEach(item => {
        const div = document.createElement("div");
        div.className = "autocomplete-item";
        div.textContent = item.name;
        div.onclick = () => {
            input.value = item.name;
            clearAutocompleteList(input);
            onSelect(item);
        };
        list.appendChild(div);
    });
}

function attachAutocomplete(input, onSelect) {
    const handler = debounce(async () => {
        const q = input.value.trim();
        if (q.length < 2) {
            clearAutocompleteList(input);
            return;
        }

        const results = await autocompleteSearchSk(q);
        if (!results.length) {
            clearAutocompleteList(input);
            return;
        }
        renderAutocomplete(input, results, onSelect);
    }, 400);

    input.addEventListener("input", handler);
    input.addEventListener("blur", () => {
        setTimeout(() => clearAutocompleteList(input), 200);
    });
}

/* ===================== OSRM ROUTING ====================== */

async function routeBetween(from, to) {
    if (!from || !to) return;

    const url = `https://router.project-osrm.org/route/v1/driving/${from[1]},${from[0]};${to[1]},${to[0]}?overview=full&geometries=geojson`;

    try {
        const res = await fetch(url);
        const data = await res.json();
        if (!data.routes || !data.routes.length) return;

        const route = data.routes[0];

        const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);

        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(coords, { color: "#2563eb", weight: 5 }).addTo(map);

        const distanceKm = route.distance / 1000;
        updateStatus(`Trasa: ${distanceKm.toFixed(2)} km`);
        map.fitBounds(routeLine.getBounds(), { padding: [30, 30] });

    } catch (e) {
        console.error("OSRM routing error:", e);
    }
}

/* ===================== TAXI LOGIKA – PO KLIENTA / S KLIENTOM ====================== */

function goToClient() {
    if (!carPosition) {
        updateStatus("Najprv potrebujem GPS polohu auta.");
        return;
    }
    if (!pickupPosition) {
        updateStatus("Vyber najprv adresu klienta (Odkiaľ).");
        return;
    }
    routeBetween(carPosition, pickupPosition);
}

function goWithClient() {
    if (!pickupPosition || !dropoffPosition) {
        updateStatus("Vyber najprv adresu Odkiaľ aj Kam.");
        return;
    }
    routeBetween(pickupPosition, dropoffPosition);
}

/* ===================== INIT ====================== */

window.addEventListener("load", () => {
    initMap();
    startGPS();

    const pickupInput = document.getElementById("pickupInput");
    const dropoffInput = document.getElementById("dropoffInput");

    // Autocomplete pre Odkiaľ
    attachAutocomplete(pickupInput, item => {
        pickupPosition = [item.lat, item.lon];

        if (pickupMarker) map.removeLayer(pickupMarker);
        pickupMarker = L.marker(pickupPosition, { title: "Klient" }).addTo(map);

        map.setView(pickupPosition, 15);

        // Ak už máme cieľ, hneď vypočítaj trasu
        if (dropoffPosition) {
            routeBetween(pickupPosition, dropoffPosition);
        }
    });

    // Autocomplete pre Kam
    attachAutocomplete(dropoffInput, item => {
        dropoffPosition = [item.lat, item.lon];

        if (dropoffMarker) map.removeLayer(dropoffMarker);
        dropoffMarker = L.marker(dropoffPosition, { title: "Cieľ" }).addTo(map);

        map.setView(dropoffPosition, 15);

        // Ak už máme Odkiaľ, hneď vypočítaj trasu
        if (pickupPosition) {
            routeBetween(pickupPosition, dropoffPosition);
        }
    });

    document.getElementById("btnToClient").addEventListener("click", goToClient);
    document.getElementById("btnWithClient").addEventListener("click", goWithClient);
});
</script>
</body>
</html>
